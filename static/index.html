<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estimate Scheduler</title>
<style>
:root {
  --pri:#2563eb;--pri-dk:#1d4ed8;--bg:#f1f5f9;
  --card:#ffffff;--text:#1e293b;--mut:#64748b;
  --bdr:#e2e8f0;--grn:#16a34a;--red:#dc2626;
  --blu-lt:#dbeafe;--r:10px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:"Segoe UI",system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text)}

header{background:var(--pri);color:#fff;padding:.85rem 1.5rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.5rem}
header h1{font-size:1.25rem;font-weight:700}
.hdr-r{display:flex;align-items:center;gap:.65rem}
.hdr-r button{background:rgba(255,255,255,.18);color:#fff;border:1px solid rgba(255,255,255,.35);padding:.45rem .9rem;border-radius:6px;cursor:pointer;font-size:.82rem;font-weight:500}
.hdr-r button:hover{background:rgba(255,255,255,.32)}
.live-dot{width:8px;height:8px;border-radius:50%;background:#4ade80;display:inline-block;margin-right:4px;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}

/* User name prompt */
.user-bar{background:#fffbeb;border-bottom:1px solid #fde68a;padding:.5rem 1.5rem;font-size:.82rem;display:flex;align-items:center;gap:.5rem}
.user-bar input{padding:.3rem .5rem;border:1px solid #fde68a;border-radius:4px;font-size:.82rem;width:150px}
.user-bar button{padding:.3rem .6rem;border:1px solid #f59e0b;background:#fef3c7;border-radius:4px;cursor:pointer;font-size:.8rem}

.region-bar{background:var(--card);border-bottom:1px solid var(--bdr);padding:0 1.5rem;display:flex;gap:0;overflow-x:auto}
.region-tab{padding:.7rem 1.3rem;font-size:.88rem;font-weight:600;color:var(--mut);cursor:pointer;border-bottom:3px solid transparent;white-space:nowrap;transition:all .15s;user-select:none}
.region-tab:hover{color:var(--text);background:#f8fafc}
.region-tab.active{color:var(--pri);border-bottom-color:var(--pri)}

.main{padding:1.25rem;overflow-x:auto}
.date-nav{display:flex;align-items:center;gap:.75rem;margin-bottom:1rem;flex-wrap:wrap}
.date-nav h2{font-size:1.05rem;font-weight:700}
.nav-btn{background:var(--card);border:1px solid var(--bdr);width:34px;height:34px;border-radius:8px;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center}
.nav-btn:hover{background:var(--blu-lt)}
.today-btn{background:var(--card);border:1px solid var(--bdr);padding:.35rem .75rem;border-radius:6px;cursor:pointer;font-size:.78rem;font-weight:500}
.today-btn:hover{background:var(--blu-lt)}
.view-btns{margin-left:auto;display:flex;gap:.25rem}
.view-btn{background:var(--card);border:1px solid var(--bdr);padding:.35rem .75rem;border-radius:6px;cursor:pointer;font-size:.78rem;font-weight:500}
.view-btn.active{background:var(--pri);color:#fff;border-color:var(--pri)}

.cal-wrap{overflow-x:auto}
table.cal{border-collapse:collapse;width:100%;min-width:700px}
table.cal th,table.cal td{border:1px solid var(--bdr);text-align:center;padding:0}
table.cal .corner{background:#f8fafc;position:sticky;left:0;z-index:5;min-width:150px}
table.cal .day-hdr{background:#f8fafc;padding:.5rem .3rem;font-size:.82rem;font-weight:700;color:var(--text)}
table.cal .day-hdr.today{background:#dbeafe;color:#1d4ed8}
table.cal .time-hdr{background:#f8fafc;padding:.35rem .2rem;font-size:.68rem;font-weight:600;color:var(--mut);text-transform:uppercase}
table.cal .est-cell{background:var(--card);font-weight:600;font-size:.85rem;color:var(--text);padding:.5rem .65rem;text-align:left;white-space:nowrap;position:sticky;left:0;z-index:2;min-width:150px;border-right:2px solid var(--bdr)}

.slot{padding:.3rem .2rem;min-height:56px;cursor:pointer;transition:background .12s;min-width:95px}
.slot:hover{background:#eff6ff}
.slot.open{background:#f0fdf4}
.slot.booked{background:#fef2f2}
.slot.off{background:#f3f4f6;cursor:default}
.badge{display:inline-block;font-size:.6rem;padding:.1rem .35rem;border-radius:3px;font-weight:700;letter-spacing:.3px}
.badge-open{background:#bbf7d0;color:#166534}
.badge-bk{background:#fecaca;color:#991b1b}
.badge-off{background:#d1d5db;color:#374151}
.slot .name{font-size:.72rem;font-weight:600;margin-top:1px}
.slot .city-line{font-size:.65rem;color:#7c3aed;font-weight:600;margin-top:1px}
.slot .type-line{font-size:.6rem;color:var(--mut)}
.slot .off-label{font-size:.72rem;color:#6b7280;font-weight:500;margin-top:2px}
.empty-msg{padding:2.5rem 1rem;text-align:center;color:var(--mut);font-size:.9rem}

/* Modals */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:100;display:flex;align-items:center;justify-content:center}
.overlay.hidden{display:none}
.modal{background:var(--card);border-radius:12px;width:95%;max-width:520px;max-height:90vh;overflow-y:auto;padding:1.75rem;box-shadow:0 20px 60px rgba(0,0,0,.2)}
.modal h2{font-size:1.05rem;margin-bottom:.2rem}
.modal .sub{font-size:.83rem;color:var(--mut);margin-bottom:1.15rem}
.modal label{display:block;font-size:.78rem;color:var(--mut);margin-bottom:.15rem;font-weight:600}
.modal input,.modal select,.modal textarea{width:100%;padding:.55rem .65rem;border:1px solid var(--bdr);border-radius:6px;font-size:.88rem;margin-bottom:.8rem;outline:none;font-family:inherit}
.modal input:focus,.modal select:focus,.modal textarea:focus{border-color:var(--pri);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.modal textarea{resize:vertical;min-height:55px}
.modal .row{display:grid;grid-template-columns:1fr 1fr;gap:0 .65rem}
.btn-row{display:flex;gap:.5rem;margin-top:.5rem}
.btn-row button{flex:1;padding:.65rem;border-radius:6px;font-size:.88rem;font-weight:600;cursor:pointer;border:none}
.btn-pri{background:var(--pri);color:#fff}.btn-pri:hover{background:var(--pri-dk)}
.btn-can{background:#f1f5f9;color:var(--mut);border:1px solid var(--bdr)!important}.btn-can:hover{background:#e2e8f0}
.btn-del{background:var(--red);color:#fff}.btn-del:hover{background:#b91c1c}

/* Edit log */
.edit-log{margin-top:1rem;border-top:1px solid var(--bdr);padding-top:.75rem}
.edit-log h4{font-size:.78rem;color:var(--mut);text-transform:uppercase;margin-bottom:.5rem}
.log-entry{font-size:.75rem;padding:.35rem 0;border-bottom:1px solid #f1f5f9;line-height:1.5}
.log-entry .log-who{font-weight:600;color:var(--text)}
.log-entry .log-action{color:var(--pri);font-weight:600}
.log-entry .log-time{color:var(--mut);font-size:.68rem}
.log-entry .log-detail{color:#475569;font-style:italic;font-size:.7rem}

.toast{position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%);padding:.7rem 1.2rem;border-radius:8px;font-size:.88rem;font-weight:500;opacity:0;transition:opacity .3s;pointer-events:none;z-index:200;color:#fff}
.toast.show{opacity:1}.toast.ok{background:#1e293b}.toast.err{background:#dc2626}

/* Settings helpers */
.est-row{display:flex;align-items:center;gap:.5rem;margin-bottom:.45rem}
.est-row input[type="text"]{flex:1;margin-bottom:0}
.est-row input[type="color"]{width:34px;height:34px;padding:2px;border-radius:6px;cursor:pointer;margin-bottom:0;border:1px solid var(--bdr)}
.est-row .rm{background:none;border:none;color:var(--red);cursor:pointer;font-size:1.1rem;padding:3px;flex-shrink:0}
.add-btn{width:100%;padding:.45rem;background:var(--blu-lt);color:var(--pri);border:1px dashed var(--pri);border-radius:6px;cursor:pointer;font-size:.82rem;font-weight:500;margin-bottom:.75rem}
.add-btn:hover{background:#bfdbfe}
.srt{display:flex;gap:.25rem;margin-bottom:1rem;flex-wrap:wrap}
.srt button{padding:.4rem .75rem;border:1px solid var(--bdr);border-radius:6px;background:var(--card);font-size:.8rem;cursor:pointer;font-weight:500}
.srt button.active{background:var(--pri);color:#fff;border-color:var(--pri)}

/* Time-off modal */
.dow-grid{display:flex;flex-wrap:wrap;gap:.4rem;margin-bottom:.75rem}
.dow-btn{padding:.4rem .75rem;border:1px solid var(--bdr);border-radius:6px;background:var(--card);font-size:.8rem;cursor:pointer}
.dow-btn.active{background:#fde68a;border-color:#f59e0b;font-weight:600}
.to-list{list-style:none;margin-top:.75rem}
.to-list li{display:flex;align-items:center;justify-content:space-between;padding:.4rem .5rem;border:1px solid var(--bdr);border-radius:6px;margin-bottom:.3rem;font-size:.82rem}
.to-list li button{background:none;border:none;color:var(--red);cursor:pointer;font-size:.9rem}

@media(max-width:768px){.main{padding:.75rem}header{padding:.75rem 1rem}.region-bar{padding:0 .75rem}}
</style>
</head>
<body>

<header>
  <h1>&#x1F4CB; Estimate Scheduler</h1>
  <div class="hdr-r">
    <span style="font-size:.8rem"><span class="live-dot"></span> Live</span>
    <button onclick="openTimeOff()">&#x1F4C5; Time Off</button>
    <button onclick="openSettings()">&#9881; Settings</button>
  </div>
</header>

<div class="user-bar">
  <span>&#x1F464; Your name:</span>
  <input id="userName" placeholder="Enter your name" />
  <button onclick="saveUserName()">Save</button>
</div>

<div class="region-bar" id="regionBar"></div>

<div class="main">
  <div class="date-nav">
    <button class="nav-btn" onclick="navigate(-1)">&#9664;</button>
    <h2 id="weekLabel"></h2>
    <button class="nav-btn" onclick="navigate(1)">&#9654;</button>
    <button class="today-btn" onclick="goToday()">Today</button>
    <div class="view-btns">
      <button class="view-btn active" id="btnWeek" onclick="setView('week')">Week</button>
      <button class="view-btn" id="btnDay" onclick="setView('day')">Day</button>
    </div>
  </div>
  <div class="cal-wrap"><table class="cal" id="calTable"></table></div>
</div>

<!-- ══ BOOKING MODAL (create + edit) ══ -->
<div class="overlay hidden" id="bookingOverlay">
  <div class="modal">
    <h2 id="bookingTitle">Schedule Estimate</h2>
    <div class="sub" id="bookingSub"></div>
    <div class="row">
      <div><label>First Name *</label><input id="bk_first"/></div>
      <div><label>Last Name *</label><input id="bk_last"/></div>
    </div>
    <div class="row">
      <div><label>Phone *</label><input id="bk_phone" type="tel"/></div>
      <div><label>Email</label><input id="bk_email" type="email"/></div>
    </div>
    <label>Street Address</label><input id="bk_address" placeholder="123 Main St"/>
    <div class="row">
      <div><label>City</label><input id="bk_city"/></div>
      <div><label>State / ZIP</label>
        <div style="display:flex;gap:.4rem">
          <input id="bk_state" maxlength="2" style="width:55px" placeholder="CA"/>
          <input id="bk_zip" maxlength="10" placeholder="ZIP"/>
        </div>
      </div>
    </div>
    <label>Flooring Type</label>
    <select id="bk_flooring">
      <option value="">-- Select --</option>
      <option>Carpet</option><option>Hardwood</option>
      <option>Laminate</option><option>Luxury Vinyl Plank (LVP)</option>
      <option>Tile</option><option>Other</option>
    </select>
    <div class="row">
      <div><label>Rooms</label><input id="bk_rooms" type="number" min="1" max="50"/></div><div></div>
    </div>
    <label>Notes</label>
    <textarea id="bk_notes" placeholder="Gate code, pets, special requests..."></textarea>
    <div id="editLogArea"></div>
    <div class="btn-row">
      <button class="btn-can" onclick="closeBooking()">Cancel</button>
      <button class="btn-del" id="btnDeleteBooking" style="display:none" onclick="deleteBooking()">Delete</button>
      <button class="btn-pri" id="btnSaveBooking" onclick="saveBooking()">Save Estimate</button>
    </div>
  </div>
</div>

<!-- ══ TIME OFF MODAL ══ -->
<div class="overlay hidden" id="timeOffOverlay">
  <div class="modal">
    <h2>&#x1F4C5; Manage Time Off</h2>
    <div class="sub">Set recurring days off or specific dates for each estimator.</div>
    <label>Estimator</label>
    <select id="to_estimator" onchange="loadTimeOffList()"></select>
    <label>Recurring Day Off (every week)</label>
    <div class="dow-grid" id="dowGrid"></div>
    <label>Specific Date(s) Off</label>
    <input id="to_date" type="date" style="margin-bottom:.4rem"/>
    <button class="add-btn" onclick="addSpecificDateOff()">+ Add Date Off</button>
    <h4 style="font-size:.8rem;color:var(--mut);margin-top:.5rem">Current Time Off</h4>
    <ul class="to-list" id="toList"></ul>
    <div class="btn-row" style="margin-top:1rem">
      <button class="btn-can" onclick="closeTimeOff()">Close</button>
    </div>
  </div>
</div>

<!-- ══ SETTINGS MODAL ══ -->
<div class="overlay hidden" id="settingsOverlay">
  <div class="modal" style="max-width:540px">
    <h2>Settings</h2>
    <div class="sub">Manage your regions and estimators.</div>
    <h3 style="font-size:.85rem;margin-bottom:.5rem">Regions</h3>
    <div id="regionEditor"></div>
    <button class="add-btn" onclick="addRegionRow()">+ Add Region</button>
    <h3 style="font-size:.85rem;margin-bottom:.5rem">Estimators</h3>
    <div class="sub">Pick a region tab, then add its estimators.</div>
    <div class="srt" id="settingsRegionTabs"></div>
    <div id="estimatorEditor"></div>
    <button class="add-btn" onclick="addEstimatorRow()">+ Add Estimator</button>
    <div class="btn-row">
      <button class="btn-can" onclick="closeSettings()">Cancel</button>
      <button class="btn-pri" onclick="saveSettings()">Save All Changes</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
var SLOTS = ["9:00 AM", "11:00 AM", "2:00 PM", "4:00 PM"];
var COLORS = ["#3b82f6","#ef4444","#16a34a","#f59e0b","#8b5cf6","#ec4899","#14b8a6","#f97316"];
var DOW_NAMES = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

var currentView = "week";
var weekStart = getMonday(new Date());
var regions = [];
var estimators = [];
var bookings = [];
var timeOffList = [];
var activeRegionId = null;
var lastBookingCount = -1;

/* Booking modal state */
var editingBookingId = null;  /* null = creating new, number = editing */
var pendingSlot = null;       /* {date, time_slot, estimator_id} for new */

/* Settings state */
var settingsRegionId = null;
var allEstimatorsCache = [];

/* ── User name ── */
var currentUser = localStorage.getItem("scheduler_user") || "";
document.getElementById("userName").value = currentUser;
function saveUserName() {
  currentUser = document.getElementById("userName").value.trim();
  localStorage.setItem("scheduler_user", currentUser);
  showToast("Name saved: " + currentUser);
}
function getUser() {
  return currentUser || document.getElementById("userName").value.trim() || "Unknown";
}

/* ═══════ UTILITIES ═══════ */
function getMonday(d) {
  d = new Date(d);
  var day = d.getDay();
  d.setDate(d.getDate() - day + (day === 0 ? -6 : 1));
  d.setHours(0,0,0,0);
  return d;
}
function dateStr(d) { return d.toISOString().slice(0,10); }
function dateNice(d) { return d.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"}); }
function dateFull(d) { return d.toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric",year:"numeric"}); }
function showToast(m, t) {
  var e = document.getElementById("toast");
  e.textContent = m; e.className = "toast " + (t||"ok") + " show";
  setTimeout(function(){ e.classList.remove("show"); }, 3000);
}
function gf(id) { return document.getElementById(id).value.trim(); }
function escH(s) { var d = document.createElement("div"); d.textContent = s; return d.innerHTML; }
function apiCall(method, url, body) {
  var opts = {method:method, headers:{"Content-Type":"application/json"}};
  if (body) opts.body = JSON.stringify(body);
  return fetch(url, opts).then(function(r) {
    return r.json().then(function(d) { if(!r.ok) throw new Error(d.error||r.statusText); return d; });
  });
}
function getDays() {
  var days = [];
  if (currentView === "week") {
    for (var i=0; i<6; i++) { var d = new Date(weekStart); d.setDate(d.getDate()+i); days.push(d); }
  } else { days.push(new Date(weekStart)); }
  return days;
}

/* ═══════ DATA LOADING ═══════ */
function loadRegions() {
  return apiCall("GET","/api/regions").then(function(d) {
    regions = d;
    if (regions.length && !activeRegionId) activeRegionId = regions[0].id;
  });
}
function loadEstimators() {
  return apiCall("GET","/api/estimators?region_id="+activeRegionId).then(function(d){ estimators=d; });
}
function loadBookings() {
  var days = getDays();
  var url = "/api/bookings?from="+dateStr(days[0])+"&to="+dateStr(days[days.length-1])+"&region_id="+activeRegionId;
  return apiCall("GET",url).then(function(d){ bookings=d; });
}
function loadTimeOff() {
  return apiCall("GET","/api/timeoff?region_id="+activeRegionId).then(function(d){ timeOffList=d; });
}
function refreshAll() {
  return loadRegions().then(loadEstimators).then(loadBookings).then(loadTimeOff).then(renderAll);
}

/* ═══════ POLLING ═══════ */
function poll() {
  apiCall("GET","/api/bookings/count").then(function(d){
    if(lastBookingCount!==-1 && d.count!==lastBookingCount){
      loadBookings().then(renderCalendar);
    }
    lastBookingCount=d.count;
  }).catch(function(){});
  setTimeout(poll, 5000);
}

/* ═══════ IS OFF CHECK ═══════ */
function isEstimatorOff(estId, dateVal) {
  var d = new Date(dateVal + "T12:00:00");
  var jsDay = d.getDay(); /* 0=Sun */
  var dow = jsDay === 0 ? 6 : jsDay - 1; /* convert to 0=Mon */
  for (var i = 0; i < timeOffList.length; i++) {
    var t = timeOffList[i];
    if (t.estimator_id !== estId) continue;
    if (t.recurring && t.day_of_week === dow) return t.label || "Off";
    if (!t.recurring && t.date === dateVal) return t.label || "Off";
  }
  return false;
}

/* ═══════ RENDERING ═══════ */
function renderAll() { renderRegionTabs(); renderCalendar(); }
function renderRegionTabs() {
  var h = "";
  for (var i=0;i<regions.length;i++) {
    var r = regions[i];
    var c = r.id===activeRegionId ? "region-tab active" : "region-tab";
    h += '<div class="'+c+'" onclick="switchRegion('+r.id+')">'+escH(r.name)+'</div>';
  }
  document.getElementById("regionBar").innerHTML = h;
}

function renderCalendar() {
  var days = getDays();
  var nS = SLOTS.length;
  var todayS = dateStr(new Date());

  if (currentView==="week") {
    var end = new Date(weekStart); end.setDate(end.getDate()+5);
    document.getElementById("weekLabel").textContent =
      weekStart.toLocaleDateString("en-US",{month:"long",day:"numeric"})+" \u2013 "+
      end.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"});
  } else {
    document.getElementById("weekLabel").textContent = dateFull(weekStart);
  }
  document.getElementById("btnWeek").classList.toggle("active", currentView==="week");
  document.getElementById("btnDay").classList.toggle("active", currentView==="day");

  var h = "<thead><tr>";
  h += '<th class="corner" rowspan="2" style="vertical-align:bottom;font-size:.7rem;">ESTIMATOR</th>';
  for (var di=0;di<days.length;di++) {
    var isT = dateStr(days[di])===todayS;
    h += '<th class="day-hdr'+(isT?' today':'')+'" colspan="'+nS+'">'+dateNice(days[di])+'</th>';
  }
  h += "</tr><tr>";
  for (var di=0;di<days.length;di++) {
    for (var si=0;si<SLOTS.length;si++) {
      h += '<th class="time-hdr">'+SLOTS[si]+'</th>';
    }
  }
  h += "</tr></thead><tbody>";

  if (!estimators.length) {
    h += '<tr><td colspan="'+(1+days.length*nS)+'" class="empty-msg">';
    h += 'No estimators in this region. Click &#9881; Settings to add some.</td></tr>';
  }

  for (var ei=0;ei<estimators.length;ei++) {
    var est = estimators[ei];
    h += '<tr><td class="est-cell">';
    h += '<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:'+est.color+';margin-right:6px;vertical-align:middle"></span>';
    h += escH(est.name) + '</td>';

    for (var di=0;di<days.length;di++) {
      var ds = dateStr(days[di]);
      var offLabel = isEstimatorOff(est.id, ds);

      if (offLabel) {
        /* Entire day is off — show OFF for every slot */
        for (var si=0;si<SLOTS.length;si++) {
          h += '<td><div class="slot off">';
          h += '<span class="badge badge-off">OFF</span>';
          h += '<div class="off-label">'+escH(offLabel)+'</div>';
          h += '</div></td>';
        }
      } else {
        for (var si=0;si<SLOTS.length;si++) {
          var slot = SLOTS[si];
          var bk = findBooking(ds, slot, est.id);
          if (bk) {
            var cityShow = bk.city || "";
            h += '<td><div class="slot booked" onclick="openEditBooking('+bk.id+')">';
            h += '<span class="badge badge-bk">BOOKED</span>';
            h += '<div class="name">'+escH(bk.first_name)+' '+escH(bk.last_name)+'</div>';
            if (cityShow) h += '<div class="city-line">\ud83d\udccd '+escH(cityShow)+'</div>';
            if (bk.flooring_type) h += '<div class="type-line">'+escH(bk.flooring_type)+'</div>';
            h += '</div></td>';
          } else {
            var eName = escH(est.name).replace(/'/g, "\\'");
            h += '<td><div class="slot open" onclick="openNewBooking(\''+ds+"','"+slot+"',"+est.id+",'"+eName+"')\">";
            h += '<span class="badge badge-open">OPEN</span>';
            h += '</div></td>';
          }
        }
      }
    }
    h += "</tr>";
  }
  h += "</tbody>";
  document.getElementById("calTable").innerHTML = h;
}

function findBooking(dv, ts, eid) {
  for(var i=0;i<bookings.length;i++){
    var b=bookings[i]; if(b.date===dv&&b.time_slot===ts&&b.estimator_id===eid) return b;
  } return null;
}
function findBookingById(id) {
  for(var i=0;i<bookings.length;i++){ if(bookings[i].id===id) return bookings[i]; } return null;
}

/* ═══════ NAVIGATION ═══════ */
function switchRegion(id) { activeRegionId=id; loadEstimators().then(loadBookings).then(loadTimeOff).then(renderAll); }
function navigate(dir) { weekStart.setDate(weekStart.getDate()+dir*(currentView==="week"?7:1)); loadBookings().then(renderCalendar); }
function goToday() { weekStart=getMonday(new Date()); loadBookings().then(renderCalendar); }
function setView(v) {
  currentView=v;
  if(v==="day"){weekStart=new Date();weekStart.setHours(0,0,0,0)} else weekStart=getMonday(new Date());
  loadBookings().then(renderCalendar);
}

/* ═══════ BOOKING MODAL ═══════ */
function openNewBooking(date, slot, estId, estName) {
  editingBookingId = null;
  pendingSlot = {date:date, time_slot:slot, estimator_id:estId};
  document.getElementById("bookingTitle").textContent = "Schedule Estimate";
  document.getElementById("bookingSub").textContent = estName + " \u2014 " + dateFull(new Date(date+"T12:00:00")) + " at " + slot;
  var fields = ["bk_first","bk_last","bk_phone","bk_email","bk_address","bk_city","bk_state","bk_zip","bk_rooms","bk_notes"];
  for(var i=0;i<fields.length;i++) document.getElementById(fields[i]).value="";
  document.getElementById("bk_flooring").value="";
  document.getElementById("btnDeleteBooking").style.display="none";
  document.getElementById("btnSaveBooking").textContent="Save Estimate";
  document.getElementById("editLogArea").innerHTML="";
  document.getElementById("bookingOverlay").classList.remove("hidden");
}

function openEditBooking(id) {
  var bk = findBookingById(id);
  if (!bk) return;
  editingBookingId = id;
  pendingSlot = null;
  document.getElementById("bookingTitle").textContent = "Edit Estimate";
  document.getElementById("bookingSub").textContent = escH(bk.estimator_name) + " \u2014 " + dateFull(new Date(bk.date+"T12:00:00")) + " at " + bk.time_slot;
  document.getElementById("bk_first").value = bk.first_name;
  document.getElementById("bk_last").value = bk.last_name;
  document.getElementById("bk_phone").value = bk.phone;
  document.getElementById("bk_email").value = bk.email || "";
  document.getElementById("bk_address").value = bk.address || "";
  document.getElementById("bk_city").value = bk.city || "";
  document.getElementById("bk_state").value = bk.state || "";
  document.getElementById("bk_zip").value = bk.zip || "";
  document.getElementById("bk_flooring").value = bk.flooring_type || "";
  document.getElementById("bk_rooms").value = bk.rooms || "";
  document.getElementById("bk_notes").value = bk.notes || "";
  document.getElementById("btnDeleteBooking").style.display="block";
  document.getElementById("btnSaveBooking").textContent="Save Changes";

  /* Load edit history */
  apiCall("GET","/api/bookings/"+id+"/log").then(function(logs){
    if(!logs.length){ document.getElementById("editLogArea").innerHTML=""; return; }
    var lh = '<div class="edit-log"><h4>Edit History</h4>';
    for(var i=0;i<logs.length;i++){
      var l = logs[i];
      var t = new Date(l.created_at);
      lh += '<div class="log-entry">';
      lh += '<span class="log-who">'+escH(l.changed_by)+'</span> ';
      lh += '<span class="log-action">'+escH(l.action)+'</span> ';
      lh += '<span class="log-time">'+t.toLocaleString()+'</span>';
      if(l.details && l.action==="Edited") lh += '<div class="log-detail">'+escH(l.details)+'</div>';
      lh += '</div>';
    }
    lh += '</div>';
    document.getElementById("editLogArea").innerHTML = lh;
  });
  document.getElementById("bookingOverlay").classList.remove("hidden");
}

function closeBooking() {
  document.getElementById("bookingOverlay").classList.add("hidden");
  editingBookingId=null; pendingSlot=null;
}

function saveBooking() {
  var firstName=gf("bk_first"), lastName=gf("bk_last"), phone=gf("bk_phone");
  if(!firstName||!lastName||!phone){ showToast("Name and phone required.","err"); return; }

  var payload = {
    first_name:firstName, last_name:lastName, phone:phone,
    email:gf("bk_email"), address:gf("bk_address"), city:gf("bk_city"),
    state:gf("bk_state"), zip:gf("bk_zip"),
    flooring_type:document.getElementById("bk_flooring").value,
    rooms:document.getElementById("bk_rooms").value||1,
    notes:gf("bk_notes")
  };

  if (editingBookingId) {
    /* UPDATE existing */
    payload.edited_by = getUser();
    apiCall("PUT","/api/bookings/"+editingBookingId, payload).then(function(){
      closeBooking(); return loadBookings();
    }).then(function(){
      renderCalendar(); showToast("\u2713 Estimate updated!");
    }).catch(function(e){ showToast(e.message,"err"); });
  } else {
    /* CREATE new */
    payload.date = pendingSlot.date;
    payload.time_slot = pendingSlot.time_slot;
    payload.estimator_id = pendingSlot.estimator_id;
    payload.created_by = getUser();
    apiCall("POST","/api/bookings", payload).then(function(){
      closeBooking(); return loadBookings();
    }).then(function(){
      renderCalendar(); showToast("\u2713 Estimate scheduled!");
    }).catch(function(e){
      showToast(e.message,"err");
      loadBookings().then(renderCalendar);
    });
  }
}

function deleteBooking() {
  if(!confirm("Cancel this estimate?")) return;
  apiCall("DELETE","/api/bookings/"+editingBookingId, {deleted_by:getUser()}).then(function(){
    closeBooking(); return loadBookings();
  }).then(function(){ renderCalendar(); showToast("Estimate cancelled."); });
}

/* ═══════ TIME OFF MODAL ═══════ */
function openTimeOff() {
  /* Populate estimator dropdown */
  var sel = document.getElementById("to_estimator");
  var h = "";
  for(var i=0;i<estimators.length;i++){
    h += '<option value="'+estimators[i].id+'">'+escH(estimators[i].name)+'</option>';
  }
  sel.innerHTML = h;

  /* Render DOW grid */
  var gh = "";
  for(var i=0;i<DOW_NAMES.length;i++){
    gh += '<div class="dow-btn" data-dow="'+i+'" onclick="toggleRecurringDay(this,'+i+')">'+DOW_NAMES[i]+'</div>';
  }
  document.getElementById("dowGrid").innerHTML = gh;

  loadTimeOffList();
  document.getElementById("timeOffOverlay").classList.remove("hidden");
}
function closeTimeOff() {
  document.getElementById("timeOffOverlay").classList.add("hidden");
  loadTimeOff().then(renderCalendar);
}

function loadTimeOffList() {
  var eid = document.getElementById("to_estimator").value;
  apiCall("GET","/api/timeoff?region_id="+activeRegionId).then(function(all){
    /* Update DOW highlights */
    var btns = document.querySelectorAll("#dowGrid .dow-btn");
    for(var i=0;i<btns.length;i++) btns[i].classList.remove("active");
    /* Build list */
    var listHtml = "";
    for(var i=0;i<all.length;i++){
      var t = all[i];
      if(String(t.estimator_id) !== String(eid)) continue;
      if(t.recurring){
        var btn = document.querySelector('#dowGrid .dow-btn[data-dow="'+t.day_of_week+'"]');
        if(btn) btn.classList.add("active");
        listHtml += '<li><span>'+escH(t.estimator_name)+' \u2014 Every '+DOW_NAMES[t.day_of_week]+' ('+escH(t.label)+')</span>';
        listHtml += '<button onclick="removeTimeOff('+t.id+')">&#10005;</button></li>';
      } else {
        var dd = new Date(t.date+"T12:00:00");
        listHtml += '<li><span>'+escH(t.estimator_name)+' \u2014 '+dateFull(dd)+' ('+escH(t.label)+')</span>';
        listHtml += '<button onclick="removeTimeOff('+t.id+')">&#10005;</button></li>';
      }
    }
    document.getElementById("toList").innerHTML = listHtml || '<li style="color:var(--mut)">No time off set</li>';
  });
}

function toggleRecurringDay(el, dow) {
  var eid = document.getElementById("to_estimator").value;
  if(el.classList.contains("active")){
    /* Find and remove */
    apiCall("GET","/api/timeoff?region_id="+activeRegionId).then(function(all){
      for(var i=0;i<all.length;i++){
        if(all[i].estimator_id===parseInt(eid) && all[i].recurring && all[i].day_of_week===dow){
          return apiCall("DELETE","/api/timeoff/"+all[i].id);
        }
      }
    }).then(function(){ loadTimeOffList(); });
  } else {
    apiCall("POST","/api/timeoff",{estimator_id:parseInt(eid),recurring:true,day_of_week:dow,label:"Off"})
      .then(function(){ loadTimeOffList(); });
  }
}

function addSpecificDateOff() {
  var eid = document.getElementById("to_estimator").value;
  var d = document.getElementById("to_date").value;
  if(!d){ showToast("Pick a date first.","err"); return; }
  apiCall("POST","/api/timeoff",{estimator_id:parseInt(eid),recurring:false,dates:[d],label:"Off"})
    .then(function(){ document.getElementById("to_date").value=""; loadTimeOffList(); showToast("Day off added."); });
}

function removeTimeOff(id) {
  apiCall("DELETE","/api/timeoff/"+id).then(function(){ loadTimeOffList(); showToast("Time off removed."); });
}

/* ═══════ SETTINGS MODAL ═══════ */
function openSettings() {
  loadRegions().then(function(){ return apiCall("GET","/api/estimators"); }).then(function(allEst){
    allEstimatorsCache = allEst;
    var rh = "";
    for(var i=0;i<regions.length;i++){
      rh += '<div class="est-row" data-id="'+regions[i].id+'">';
      rh += '<input type="text" value="'+escH(regions[i].name)+'"/>';
      rh += '<button class="rm" onclick="this.parentElement.remove()">&#10005;</button></div>';
    }
    document.getElementById("regionEditor").innerHTML = rh;
    settingsRegionId = regions.length ? regions[0].id : null;
    renderSettingsEstimators();
    document.getElementById("settingsOverlay").classList.remove("hidden");
  });
}
function closeSettings(){ document.getElementById("settingsOverlay").classList.add("hidden"); }

function renderSettingsEstimators(){
  var th="";
  for(var i=0;i<regions.length;i++){
    var r=regions[i];
    th+='<button class="'+(r.id===settingsRegionId?"active":"")+'" onclick="switchSettingsRegion('+r.id+')">'+escH(r.name)+'</button>';
  }
  document.getElementById("settingsRegionTabs").innerHTML=th;
  var eh="";
  for(var i=0;i<allEstimatorsCache.length;i++){
    var e=allEstimatorsCache[i];
    if(e.region_id!==settingsRegionId)continue;
    eh+='<div class="est-row" data-id="'+e.id+'">';
    eh+='<input type="color" value="'+e.color+'"/>';
    eh+='<input type="text" value="'+escH(e.name)+'"/>';
    eh+='<button class="rm" onclick="this.parentElement.remove()">&#10005;</button></div>';
  }
  document.getElementById("estimatorEditor").innerHTML=eh;
}
function switchSettingsRegion(id){ saveEstimatorsToCache(); settingsRegionId=id; renderSettingsEstimators(); }
function saveEstimatorsToCache(){
  if(!settingsRegionId)return;
  allEstimatorsCache=allEstimatorsCache.filter(function(e){return e.region_id!==settingsRegionId});
  var rows=document.querySelectorAll("#estimatorEditor .est-row");
  for(var i=0;i<rows.length;i++){
    var n=rows[i].querySelector('input[type="text"]').value.trim();
    var c=rows[i].querySelector('input[type="color"]').value;
    var id=rows[i].dataset.id?parseInt(rows[i].dataset.id):null;
    if(n) allEstimatorsCache.push({id:id,name:n,color:c,region_id:settingsRegionId,active:1});
  }
}
function addRegionRow(){
  var d=document.createElement("div");d.className="est-row";
  d.innerHTML='<input type="text" placeholder="Region name"/><button class="rm" onclick="this.parentElement.remove()">&#10005;</button>';
  document.getElementById("regionEditor").appendChild(d);
}
function addEstimatorRow(){
  var ed=document.getElementById("estimatorEditor");var n=ed.children.length;
  var d=document.createElement("div");d.className="est-row";
  d.innerHTML='<input type="color" value="'+COLORS[n%COLORS.length]+'"/><input type="text" placeholder="Estimator name"/><button class="rm" onclick="this.parentElement.remove()">&#10005;</button>';
  ed.appendChild(d);
}
function saveSettings(){
  var regRows=document.querySelectorAll("#regionEditor .est-row");
  var regList=[];
  for(var i=0;i<regRows.length;i++){
    var n=regRows[i].querySelector('input[type="text"]').value.trim();
    var id=regRows[i].dataset.id?parseInt(regRows[i].dataset.id):null;
    if(n)regList.push({id:id,name:n});
  }
  if(!regList.length){showToast("Add at least one region.","err");return;}
  saveEstimatorsToCache();
  apiCall("POST","/api/regions",regList).then(loadRegions).then(function(){
    var promises=[];
    for(var r=0;r<regions.length;r++){
      var rid=regions[r].id;
      var re=allEstimatorsCache.filter(function(e){return e.region_id===rid});
      var el=re.map(function(e){return{id:e.id,name:e.name,color:e.color}});
      if(el.length) promises.push(apiCall("POST","/api/estimators",{region_id:rid,estimators:el}));
    }
    return Promise.all(promises);
  }).then(function(){
    closeSettings(); return refreshAll();
  }).then(function(){
    showToast("\u2713 Settings saved!");
  }).catch(function(e){ showToast("Error: "+e.message,"err"); });
}

/* ═══════ BOOT ═══════ */
refreshAll().then(poll);
</script>
</body>
</html>